#!/usr/bin/env ruby

$:.unshift File.expand_path("../../lib", __FILE__)

require "rubygems"
require "bundler/setup"
require "logger"
require "heartbeat"
require "optparse"
require "yaml"
require "hashr"

options = { :config => File.expand_path("../../config/heartbeat*.yml", __FILE__) }

OptionParser.new do |opts|
  opts.on("--config config") { |config| options[:config] = config }

  opts.on "--version" do
    puts Heartbeat::VERSION

    exit 0
  end

  opts.on "--help" do
    puts opts

    exit 0
  end
end.parse!

Heartbeat.logger = Logger.new(File.expand_path("../../log/heartbeat.log", __FILE__), 3, 10_485_760)

threads = Dir.glob(options[:config]).collect do |path|
  Thread.new path do |file|
    Heartbeat.logger.info "Reading configuration from #{file}."

    Heartbeat.config = Hashr.new(YAML.load_file(file))
    Heartbeat.config.ips = Heartbeat.config.ips.collect { |ip| Hashr.new ip }

    Heartbeat::Controller.new.start
  end
end

threads.each(&:join)

